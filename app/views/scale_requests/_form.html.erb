<%= form_with(model: [@scale_request], local: true, class: 'needs-validation', novalidate: true) do |f| %>
  <% if @scale_request.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= I18n.t("errors.messages.not_saved", count: @scale_request.errors.count, resource: @scale_request.class.model_name.human.downcase) %></h4>
      <ul>
        <% @scale_request.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-3">
    <h2><%= f.label :patient_id, t('scale_requests.form.patient') %></h2>
    <%= f.select :patient_id, 
        options_from_collection_for_select(@patients, :id, :full_name, @scale_request.patient_id),
        { include_blank: "Digite para buscar um paciente..." }, 
        { 
          class: 'form-select', 
          required: true,
          id: 'patient-select'
        } %>
    <div class="form-text">
      <i class="bi bi-search me-1"></i>
      Digite pelo menos 2 caracteres para buscar pacientes
    </div>
  </div>

  <div class="mb-3">
    <h2><%= f.label :psychometric_scale_id, t('scale_requests.form.scale') %></h2>
    <%= f.collection_select :psychometric_scale_id, @psychometric_scales, :id, :name, { include_blank: "Selecione a Escala" }, { class: 'form-select', required: true } %>
  </div>

  <div class="mb-3">
    <%= f.label :notes, t('scale_requests.form.notes'), class: 'form-label' %>
    <%= f.text_area :notes, class: 'form-control', rows: 3 %>
  </div>

  <div class="mt-3">
    <%= f.submit t('scale_requests.form.submit'), class: 'btn btn-primary' %>
    <%= link_to t('actions.cancel'), scale_requests_path, class: 'btn btn-secondary' %>
  </div>
<% end %>

<script>
$(document).ready(function() {
  $('#patient-select').select2({
    theme: 'bootstrap-5',
    width: '100%',
    language: {
      inputTooShort: function () {
        return 'Digite pelo menos 2 caracteres';
      },
      searching: function () {
        return 'Buscando...';
      },
      noResults: function () {
        return 'Nenhum resultado encontrado';
      },
      loadingMore: function () {
        return 'Carregando mais resultados...';
      },
      maximumSelected: function (args) {
        return 'Você só pode selecionar ' + args.maximum + ' item(s)';
      },
      removeAllItems: function () {
        return 'Remover todos os itens';
      },
      removeItem: function () {
        return 'Remover item';
      },
      search: function () {
        return 'Buscar';
      }
    },
    ajax: {
      url: '<%= search_patients_path %>',
      dataType: 'json',
      delay: 250,
      cache: true,
      data: function (params) {
        return {
          q: params.term
        };
      },
      processResults: function (data) {
        return {
          results: data
        };
      }
    },
    minimumInputLength: 2,
    placeholder: 'Digite para buscar um paciente...',
    allowClear: true,
    templateResult: function(patient) {
      if (patient.loading) {
        return patient.text;
      }
      
      var $result = $(
        '<div class="d-flex justify-content-between align-items-center">' +
          '<div>' +
            '<div class="fw-semibold">' + patient.text + '</div>' +
            '<small class="text-muted">' + patient.email + '</small>' +
          '</div>' +
        '</div>'
      );
      
      return $result;
    },
    templateSelection: function(patient) {
      return patient.text || patient.id;
    }
  });
});
</script>
