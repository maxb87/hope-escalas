<% if scale_requests.any? %>
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th class="py-3">
            <i class="bi bi-person me-1"></i>
            <%= t('scale_requests.table.patient') %>
          </th>
          <th class="py-3">
            <i class="bi bi-clipboard-pulse me-1"></i>
            <%= t('scale_requests.table.scale') %>
          </th>
          <th class="py-3">
            <i class="bi bi-person-badge me-1"></i>
            <%= t('scale_requests.table.professional') %>
          </th>
          <th class="py-3">
            <i class="bi bi-activity me-1"></i>
            <%= t('scale_requests.table.status') %>
          </th>
          <th class="py-3">
            <i class="bi bi-calendar me-1"></i>
            <%= t('scale_requests.table.requested_at') %>
          </th>
          <th class="py-3">
            <i class="bi bi-bar-chart me-1"></i>
            <%= t('scale_requests.table.results') %>
          </th>
          <th class="py-3 text-center">
            <i class="bi bi-gear me-1"></i>
            <%= t('scale_requests.table.actions') %>
          </th>
        </tr>
      </thead>
      <tbody>
        <% scale_requests.each do |req| %>
          <tr>
            <td class="py-3">
              <div class="d-flex align-items-center">
                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                  <%= req.patient.full_name.first.upcase %>
                </div>
                <div>
                  <div class="fw-semibold"><%= req.patient.full_name %></div>
                  <small class="text-muted"><%= req.patient.email %></small>
                </div>
              </div>
            </td>
            <td class="py-3">
              <div>
                <div class="fw-medium"><%= req.psychometric_scale.name %></div>
                <small class="text-muted">
                  <i class="bi bi-clipboard2-data me-1"></i>
                  <%= req.psychometric_scale.code %>
                </small>
              </div>
            </td>
            <td class="py-3">
              <div>
                <div class="fw-medium"><%= req.professional.full_name %></div>
                <small class="text-muted"><%= req.professional.email %></small>
              </div>
            </td>
            <td class="py-3">
              <% case req.status %>
              <% when 'pending' %>
                <span class="badge bg-warning">
                  <i class="bi bi-clock me-1"></i>
                  <%= t('scale_requests.status.pending') %>
                </span>
              <% when 'completed' %>
                <span class="badge bg-success">
                  <i class="bi bi-check-circle me-1"></i>
                  <%= t('scale_requests.status.completed') %>
                </span>
              <% when 'cancelled' %>
                <span class="badge bg-danger">
                  <i class="bi bi-x-circle me-1"></i>
                  <%= t('scale_requests.status.cancelled') %>
                </span>
              <% when 'expired' %>
                <span class="badge bg-secondary">
                  <i class="bi bi-clock-history me-1"></i>
                  <%= t('scale_requests.status.expired') %>
                </span>
              <% end %>
            </td>
            <td class="py-3">
              <div>
                <%= l(req.requested_at, format: :short) %>
                <div>
                  <small class="text-muted">
                    <%= time_ago_in_words(req.requested_at) %> atrás
                  </small>
                </div>
              </div>
            </td>
            <td class="py-3">
                <% if req.pending? && policy(req).respond? %>
                  <% if req.psychometric_scale.code.in?(["SRS2SR", "SRS2HR"]) %>
                    <%= link_to new_srs2_scale_response_path(scale_request_id: req.id), 
                        class: 'btn btn-sm btn-outline-warning',
                        title: t('scale_requests.actions.fill_scale'),
                        data: { turbo_frame: "_top" } do %>
                      <i class="bi bi-pencil"></i>
                    <% end %>
                  <% else %>
                    <%= link_to new_scale_response_path(scale_request_id: req.id), 
                        class: 'btn btn-sm btn-outline-warning',
                        title: t('scale_requests.actions.fill_scale'),
                        data: { turbo_frame: "_top" } do %>
                      <i class="bi bi-pencil"></i>
                    <% end %>
                  <% end %>
                <% end %>
              <% if req.scale_response.present? %>
                <div>

                  <div class="mt-1">
                    <% interpretation = req.scale_response.interpretation_level %>
                    <% case interpretation %>
                    <% when "Normal" %>
                      <span class="badge bg-success"><%= interpretation %></span>
                    <% when "Leve" %>
                      <span class="badge bg-warning"><%= interpretation %></span>
                    <% when "Moderado" %>
                      <span class="badge bg-orange"><%= interpretation %></span>
                    <% when "Severo" %>
                      <span class="badge bg-danger"><%= interpretation %></span>
                    <% end %>
                  </div>
                  <span class="badge bg-light text-dark">
                    <i class="bi bi-calculator me-1"></i>
                    <%= req.scale_response.total_score %> pts
                  </span>
                </div>
              <% else %>
                <span class="text-muted">
                  <i class="bi bi-dash"></i>
                  <%= t('scale_requests.table.no_result') %>
                </span>
              <% end %>
            </td>
            <td class="py-3 text-center">
              <div class="btn-group" role="group">
                <%= link_to scale_request_path(req), 
                    class: 'btn btn-sm btn-outline-primary',
                    title: t('actions.show'),
                    data: { turbo_frame: "_top" } do %>
                  <i class="bi bi-eye"></i>
                <% end %>
                
                <% if req.pending? && policy(req).respond? %>
                  <% if req.psychometric_scale.code.in?(["SRS2SR", "SRS2HR"]) %>
                    <%= link_to new_srs2_scale_response_path(scale_request_id: req.id), 
                        class: 'btn btn-sm btn-outline-warning',
                        title: t('scale_requests.actions.fill_scale'),
                        data: { turbo_frame: "_top" } do %>
                      <i class="bi bi-pencil"></i>
                    <% end %>
                  <% else %>
                    <%= link_to new_scale_response_path(scale_request_id: req.id), 
                        class: 'btn btn-sm btn-outline-warning',
                        title: t('scale_requests.actions.fill_scale'),
                        data: { turbo_frame: "_top" } do %>
                      <i class="bi bi-pencil"></i>
                    <% end %>
                  <% end %>
                <% end %>
                <% if req.scale_response.present? %>
                  <% if req.scale_response.psychometric_scale.code.in?(["SRS2SR", "SRS2HR"]) %>
                    <%= link_to srs2_scale_response_path(req.scale_response), 
                        class: 'btn btn-sm btn-outline-success',
                        title: t('scale_requests.actions.view_response'),
                        data: { turbo_frame: "_top" } do %>
                      <i class="bi bi-bar-chart"></i>
                    <% end %>
                  <% else %>
                    <%= link_to scale_response_path(req.scale_response), 
                        class: 'btn btn-sm btn-outline-success',
                        title: t('scale_requests.actions.view_response'),
                        data: { turbo_frame: "_top" } do %>
                      <i class="bi bi-bar-chart"></i>
                    <% end %>
                  <% end %>
                <% end %>
                
                <% if req.pending? && policy(req).cancel? %>
                  <%= link_to cancel_scale_request_path(req), 
                      class: 'btn btn-sm btn-outline-danger',
                      title: t('scale_requests.actions.cancel'),
                      data: { 
                        turbo_method: :patch,
                        confirm: t('scale_requests.actions.cancel_confirm'),
                        turbo_frame: "_top"
                      } do %>
                    <i class="bi bi-x"></i>
                  <% end %>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  
  <!-- Paginação -->
  <div class="card-footer d-flex justify-content-between align-items-center">
    <small class="text-muted">
      <%= t('scale_requests.table.showing_count', count: scale_requests.count) %>
    </small>
    <!-- Aqui pode adicionar paginação futuramente -->
  </div>
<% else %>
  <!-- Estado vazio -->
  <div class="d-flex flex-column align-items-center justify-content-center py-5 text-center">
    <div class="mb-3">
      <i class="bi bi-clipboard-x text-muted" style="font-size: 3rem;"></i>
    </div>
    <h5 class="text-muted mb-2"><%= t('scale_requests.table.empty_title') %></h5>
    <p class="text-muted mb-4"><%= t('scale_requests.table.empty_description') %></p>
    
    <%= link_to new_scale_request_path, 
        class: 'btn btn-warning',
        data: { turbo_frame: "_top" } do %>
      <i class="bi bi-plus-circle me-2"></i>
      <%= t('scale_requests.new.button') %>
    <% end %>
  </div>
<% end %>

<style>
.avatar-sm {
  width: 32px;
  height: 32px;
  font-size: 0.875rem;
}

.bg-orange {
  background-color: #fd7e14 !important;
}

.table-hover tbody tr:hover {
  background-color: rgba(0, 0, 0, 0.02);
}
</style>
