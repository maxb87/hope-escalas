<% if user_signed_in? %>
  <% account = current_user.account %>
  <% is_admin = current_user.email == "admin@admin.com" %>
  <% is_professional = account.is_a?(Professional) %>
  <% is_patient = account.is_a?(Patient) %>

  <!-- Sidebar Toggle Button (Mobile) -->
  <button class="btn d-lg-none position-fixed top-0 start-0 mt-3 ms-3 z-3 border-0 sidebar-toggle-mobile" 
          type="button" 
          data-bs-toggle="offcanvas" 
          data-bs-target="#sidebarOffcanvas" 
          aria-controls="sidebarOffcanvas">
    <div class="d-flex align-items-center">
      <svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-2">
        <path d="M1 1H19" stroke="black" stroke-width="2" stroke-linecap="round"/>
        <path d="M1 8H19" stroke="black" stroke-width="2" stroke-linecap="round"/>
        <path d="M1 15H19" stroke="black" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="text-dark fw-medium">Menu</span>
    </div>
  </button>

  <!-- Sidebar -->
  <div class="sidebar-container">
    <!-- Desktop Sidebar -->
    <nav class="sidebar d-none d-lg-flex flex-column p-3 bg-white border-end shadow-sm">
      <div class="sidebar-header mb-4">
        <div>
          <%= image_tag "logo-text.webp", class: "me-2", style: "width: 150px; height: 75px;" %>       
        </div>
        <div>
          <% if current_user.account.is_a?(Professional)%>
            <strong><%= current_user.account.full_name %></strong>
          <% end %>
        </div>
      </div>
      
      <ul class="nav nav-pills flex-column mb-auto">
        <% if is_patient %>
          <li class="nav-item mb-2">
            <%= link_to patients_dashboard_path,
                class: "nav-link d-flex align-items-center #{'active' if current_page?(patients_dashboard_path)}" do %>
              <i class="bi bi-house me-3 fs-5"></i>
              <span>Início</span>
            <% end %>
          </li>
        <% elsif is_professional || is_admin %>
          <li class="nav-item mb-2">
            <%= link_to scale_requests_path,
                class: "nav-link d-flex align-items-center #{'active' if current_page?(scale_requests_path)}" do %>
              <i class="bi bi-clipboard-data me-3 fs-5"></i>
              <span>Solicitações</span>
            <% end %>
          </li>

          <li class="nav-item mb-2">
            <%= link_to patients_path,
                class: "nav-link d-flex align-items-center #{'active' if current_page?(patients_path)}" do %>
              <i class="bi bi-list-check me-3 fs-5"></i>
              <span>Lista de Pacientes</span>
            <% end %>
          </li>

          <li class="nav-item mb-2">
            <%= link_to new_patient_path,
                class: "nav-link d-flex align-items-center #{'active' if current_page?(new_patient_path)}" do %>
              <i class="bi bi-person-plus me-3 fs-5"></i>
              <span>Cadastrar Paciente</span>
            <% end %>
          </li>

          <li class="nav-item mb-2">
            <%= link_to professionals_path,
                class: "nav-link d-flex align-items-center #{'active' if current_page?(professionals_path)}" do %>
              <i class="bi bi-people me-3 fs-5"></i>
              <span>Lista de Profissionais</span>
            <% end %>
          </li>

          <li class="nav-item mb-2">
            <%= link_to new_professional_path,
                class: "nav-link d-flex align-items-center #{'active' if current_page?(new_professional_path)}" do %>
              <i class="bi bi-person-badge me-3 fs-5"></i>
              <span>Cadastrar Profissional</span>
            <% end %>
          </li>
        <% end %>
      </ul>

      <hr class="my-3">

      <div class="sidebar-footer">
        <%= button_to destroy_user_session_path, method: :delete,
            class: "nav-link d-flex align-items-center text-danger border-0 bg-transparent" do %>
          <i class="bi bi-box-arrow-right me-3 fs-5"></i>
          <span>Sair</span>
        <% end %>
      </div>
    </nav>

    <!-- Mobile Offcanvas Sidebar -->
    <div class="offcanvas offcanvas-start d-lg-none" 
         tabindex="-1" 
         id="sidebarOffcanvas" 
         aria-labelledby="sidebarOffcanvasLabel"
         data-controller="sidebar">

      <div class="offcanvas-body">
        <!-- Logo e informações do usuário (igual ao desktop) -->
        <div class="sidebar-header mb-4">
          <div class="mb-3">
            <%= image_tag "logo-text.webp", class: "me-2", style: "width: 150px; height: 75px;" %>       
          </div>
          <div>
            <% if current_user.account.is_a?(Professional)%>
              <strong><%= current_user.account.full_name %></strong>
            <% end %>
          </div>
        </div>

        <ul class="nav nav-pills flex-column mb-auto">
          <% if is_patient %>
            <li class="nav-item mb-2">
              <%= link_to patients_dashboard_path,
                  class: "nav-link d-flex align-items-center #{'active' if current_page?(patients_dashboard_path)}",
                  data: { action: "click->sidebar#closeSidebar" } do %>
                <i class="bi bi-house me-3 fs-5"></i>
                <span>Início</span>
              <% end %>
            </li>
          <% elsif is_professional || is_admin %>
            <li class="nav-item mb-2">
              <%= link_to scale_requests_path,
                  class: "nav-link d-flex align-items-center #{'active' if current_page?(scale_requests_path)}",
                  data: { action: "click->sidebar#closeSidebar" } do %>
                <i class="bi bi-clipboard-data me-3 fs-5"></i>
                <span>Solicitações</span>
              <% end %>
            </li>

            <li class="nav-item mb-2">
              <%= link_to patients_path,
                  class: "nav-link d-flex align-items-center #{'active' if current_page?(patients_path)}",
                  data: { action: "click->sidebar#closeSidebar" } do %>
                <i class="bi bi-list-check me-3 fs-5"></i>
                <span>Lista de Pacientes</span>
              <% end %>
            </li>

            <li class="nav-item mb-2">
              <%= link_to new_patient_path,
                  class: "nav-link d-flex align-items-center #{'active' if current_page?(new_patient_path)}",
                  data: { action: "click->sidebar#closeSidebar" } do %>
                <i class="bi bi-person-plus me-3 fs-5"></i>
                <span>Cadastrar Paciente</span>
              <% end %>
            </li>

            <li class="nav-item mb-2">
              <%= link_to professionals_path,
                  class: "nav-link d-flex align-items-center #{'active' if current_page?(professionals_path)}",
                  data: { action: "click->sidebar#closeSidebar" } do %>
                <i class="bi bi-people me-3 fs-5"></i>
                <span>Lista de Profissionais</span>
              <% end %>
            </li>

            <li class="nav-item mb-2">
              <%= link_to new_professional_path,
                  class: "nav-link d-flex align-items-center #{'active' if current_page?(new_professional_path)}",
                  data: { action: "click->sidebar#closeSidebar" } do %>
                <i class="bi bi-person-badge me-3 fs-5"></i>
                <span>Cadastrar Profissional</span>
              <% end %>
            </li>
          <% end %>
        </ul>

        <hr class="my-3">

        <div class="sidebar-footer">
          <%= button_to destroy_user_session_path, method: :delete,
              class: "nav-link d-flex align-items-center text-danger border-0 bg-transparent",
              data: { action: "click->sidebar#closeSidebar" } do %>
            <i class="bi bi-box-arrow-right me-3 fs-5"></i>
            <span>Sair</span>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <style>
    .sidebar-container {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      z-index: 1000;
    }

    .sidebar {
      width: 280px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background: white;
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar .nav-link {
      color: #6c757d;
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
      margin-bottom: 0.25rem;
      transition: all 0.2s ease-in-out;
    }

    .sidebar .nav-link:hover {
      color: #0d6efd;
      background-color: #f8f9fa;
    }

    .sidebar .nav-link.active {
      color: #0d6efd;
      background-color: #e7f1ff;
      font-weight: 500;
    }

    .sidebar .nav-link i {
      min-width: 20px;
    }

    .sidebar-header {
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 1rem;
    }

    .sidebar-footer {
      padding-top: 1rem;
    }

    /* Main content adjustment for desktop */
    @media (min-width: 992px) {
      .main-content {
        margin-left: 280px;
        transition: margin-left 0.3s ease-in-out;
      }
    }

    /* Mobile sidebar toggle button */
    .sidebar-toggle-mobile {
      background: white;
      border-radius: 8px;
      height: 44px;
      border: 2px solid #6c757d;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 0 12px;
      z-index: 1030;
    }

    /* Offcanvas backdrop adjustment */
    .offcanvas-backdrop {
      z-index: 1040;
    }

    .offcanvas {
      z-index: 1050;
    }

    /* Mobile offcanvas styling to match desktop sidebar */
    .offcanvas .nav-link {
      color: #6c757d;
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
      margin-bottom: 0.25rem;
      transition: all 0.2s ease-in-out;
    }

    .offcanvas .nav-link:hover {
      color: #0d6efd;
      background-color: #f8f9fa;
    }

    .offcanvas .nav-link.active {
      color: #0d6efd;
      background-color: #e7f1ff;
      font-weight: 500;
    }

    .offcanvas .nav-link i {
      min-width: 20px;
    }

    .offcanvas .sidebar-header {
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 1rem;
    }

    .offcanvas .sidebar-footer {
      padding-top: 1rem;
    }
  </style>
<% end %>