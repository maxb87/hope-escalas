<h2>Respostas de Escalas</h2>

<% if @scale_responses.any? %>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Paciente</th>
          <th>Escala</th>
          <th>Data de Conclusão</th>
          <th>Pontuação Total</th>
          <th>Interpretação</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <% @scale_responses.each do |response| %>
          <tr>
            <td><%= response.patient.full_name %></td>
            <td><%= response.psychometric_scale.name %></td>
            <td><%= response.completed_at.strftime("%d/%m/%Y %H:%M") %></td>
            <td><%= response.total_score %></td>
            <td><%= response.interpretation %></td>
            <td>
              <% if response.psychometric_scale.code.in?(["SRS2SR", "SRS2HR"]) %>
                <%= link_to "Ver", srs2_scale_response_path(response), class: "btn btn-sm btn-outline-primary" %>
              <% else %>
                <%= link_to "Ver", response, class: "btn btn-sm btn-outline-primary" %>
              <% end %>
              
              <!-- Botão de Interpretação seguindo as regras estabelecidas - apenas para profissionais/admin -->
              <% if professional_or_admin? %>
                <% if response.psychometric_scale.code == "SRS2SR" %>
                  <!-- Para autorelato SRS-2: link direto para interpretação -->
                  <%= link_to "Interpretação", interpretation_srs2_scale_response_path(response), class: 'btn btn-sm btn-warning ms-2' %>
                <% elsif response.psychometric_scale.code == "SRS2HR" %>
                  <!-- Para heterorelato SRS-2: buscar autorrelato correspondente -->
                  <% self_report_response = find_corresponding_self_report_for(response.patient) %>
                  <% if self_report_response %>
                    <%= link_to "Interpretação", interpretation_srs2_scale_response_path(self_report_response), class: 'btn btn-sm btn-warning ms-2' %>
                  <% else %>
                    <span class="btn btn-sm btn-secondary ms-2 disabled" title="Autorrelato SRS-2 necessário para interpretação">Interpretação</span>
                  <% end %>
                <% end %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <div class="alert alert-info">
    <p>Nenhuma resposta de escala encontrada.</p>
  </div>
<% end %>
