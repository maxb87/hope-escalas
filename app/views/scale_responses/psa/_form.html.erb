<% 
  # Mapeamento das categorias PSA
  psa_categories = {
    'A' => { name: 'Processamento Tátil/Olfativo', items: (1..8).to_a },
    'B' => { name: 'Processamento Vestibular/Proprioceptivo', items: (9..16).to_a },
    'C' => { name: 'Processamento Visual', items: (17..26).to_a },
    'D' => { name: 'Processamento Tátil', items: (27..39).to_a },
    'E' => { name: 'Nível de Atividade', items: (40..49).to_a },
    'F' => { name: 'Processamento Auditivo', items: (50..60).to_a }
  }
%>

<div class="accordion" id="psaFormAccordion">
  <% psa_categories.each_with_index do |(category_code, category_data), index| %>
    <% category_items = @scale_items.select { |item| category_data[:items].include?(item.item_number) } %>
    
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading<%= category_code %>">
        <button class="accordion-button <%= 'collapsed' unless index == 0 %>" 
                type="button" 
                data-bs-toggle="collapse" 
                data-bs-target="#collapse<%= category_code %>" 
                aria-expanded="<%= index == 0 ? 'true' : 'false' %>" 
                aria-controls="collapse<%= category_code %>">
          <i class="bi bi-list-check me-2"></i>
          <strong>Item <%= category_code %>: <%= category_data[:name]%></strong>
          <span class="badge bg-secondary ms-2"><%= category_items.count %> questões</span>
        </button>
      </h2>
      
      <div id="collapse<%= category_code %>" 
           class="accordion-collapse collapse <%= 'show' if index == 0 %>" 
           aria-labelledby="heading<%= category_code %>" 
           data-bs-parent="#psaFormAccordion">
        <div class="accordion-body">
          
          <!-- Questões da categoria -->
          <div class="mb-4">
            <% category_items.each do |item| %>
              <div class="card mb-3">
                <div class="card-body">
                  <h6 class="card-title">
                    <span class="badge bg-primary me-2"><%= item.item_number %></span>
                    <%= item.question_text %>
                  </h6>
                  
                  <div class="mt-3">
                    <% item.options.sort_by { |k,_| k.to_i }.each do |score, label| %>
                      <div class="form-check">
                        <%= radio_button_tag "scale_response[answers][item_#{item.item_number}]", 
                            score, false, class: "form-check-input", 
                            id: "item_#{item.item_number}_#{score}" %>
                        <label class="form-check-label" for="item_<%= item.item_number %>_<%= score %>">
                          <strong><%= score %></strong> — <%= label %>
                        </label>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
          
          <!-- Campo de comentários da categoria -->
          <div class="card bg-light">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="bi bi-chat-text me-2"></i>
                Comentários sobre <%= category_data[:name] %>
              </h6>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="comment_<%= category_code.downcase %>" class="form-label">
                  Descreva suas experiências pessoais relacionadas a este processamento sensorial:
                </label>
                <%= text_area_tag "scale_response[answers][comment_category_#{category_code.downcase}]", 
                    "", class: "form-control", 
                    id: "comment_#{category_code.downcase}",
                    rows: 3,
                    placeholder: "Ex: Situações específicas, reações particulares, estratégias que utiliza, etc." %>
                <div class="form-text">
                  <i class="bi bi-info-circle me-1"></i>
                  Este campo é opcional, mas suas observações podem ajudar na interpretação dos resultados.
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
function fillRandomAnswers() {
  // Preencher todas as respostas aleatoriamente
  const radioButtons = document.querySelectorAll("input[type='radio'][name*='scale_response[answers][item_']");
  
  // Agrupar por item
  const items = {};
  radioButtons.forEach(radio => {
    const name = radio.name;
    if (!items[name]) items[name] = [];
    items[name].push(radio);
  });
  
  // Selecionar uma opção aleatória para cada item
  Object.values(items).forEach(itemRadios => {
    const randomIndex = Math.floor(Math.random() * itemRadios.length);
    itemRadios[randomIndex].checked = true;
  });
  
  // Preencher comentários de exemplo
  const commentAreas = document.querySelectorAll("textarea[name*='comment_category_']");
  const sampleComments = [
    "Percebo que tenho maior sensibilidade nesta área.",
    "Costumo evitar certas situações por causa do desconforto.",
    "Algumas vezes busco ativamente essas experiências sensoriais.",
    "Não noto muito essas sensações no meu dia a dia.",
    "Tenho desenvolvido estratégias para lidar com essas situações."
  ];
  
  commentAreas.forEach(textarea => {
    if (Math.random() > 0.3) { // 70% de chance de preencher comentário
      textarea.value = sampleComments[Math.floor(Math.random() * sampleComments.length)];
    }
  });
  
  alert("Formulário PSA preenchido aleatoriamente!");
}
</script> 