<% is_patient = current_user.account_type == "Patient" %>
<% is_professional_or_admin = current_user.email == "admin@admin.com" || current_user.account_type == "Professional" %>

<% if is_patient %>
  <h2><%= @scale_response.psychometric_scale.name %> — Respostas</h2>
<% else %>
  <h2><%= @scale_response.psychometric_scale.name %> — Resultado</h2>
<% end %>

<div class="mb-3">
  <strong>Paciente:</strong> <%= @scale_response.patient.full_name %><br/>
  <strong>Preenchido em:</strong> <%= l(@scale_response.completed_at, format: :short) %>
</div>

<% unless is_patient %>
  <div class="mb-3">
    <strong>Pontuação total:</strong> <%= @scale_response.total_score %><br/>
    <strong>Interpretação:</strong> <%= @scale_response.interpretation %>
  </div>

  <% if @scale_response.results.present? %>
    <% metrics = @scale_response.results["metrics"] || {} %>
    <% subscales = @scale_response.results["subscales"] || {} %>
    <% interp = @scale_response.results["interpretation"] || {} %>

    <% if metrics.present? %>
      <h3>Métricas</h3>
      <table class="table table-sm w-auto">
        <tbody>
        <% metrics.each do |key, value| %>
          <tr>
            <th class="text-nowrap"><%= key.humanize %></th>
            <td><%= value %></td>
          </tr>
        <% end %>
        </tbody>
      </table>
    <% end %>

    <% if subscales.present? %>
      <h3>Subescalas</h3>
      <table class="table table-sm w-auto">
        <tbody>
        <% subscales.each do |key, value| %>
          <tr>
            <th class="text-nowrap"><%= key.humanize %></th>
            <td><%= value %></td>
          </tr>
        <% end %>
        </tbody>
      </table>
    <% end %>

    <% if interp.present? && interp["rules"].present? %>
      <p class="text-muted">Regra: <%= interp["rules"] %></p>
    <% end %>
  <% end %>
<% end %>

<h3>Respostas por item</h3>
<div class="row">
  <div class="col-12">
    <% @scale_response.psychometric_scale.scale_items.ordered.each do |item| %>
      <% key = "item_#{item.item_number}" %>
      <% selected_score = @scale_response.answers[key].to_i %>

      <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-question-circle me-2"></i>
            <%= item.item_number %>. <%= item.question_text %>
          </h5>
        </div>
        <div class="card-body">
          <div class="list-group">
            <% item.options.sort_by { |score, text| score.to_i }.each do |score, text| %>
              <% is_selected = score.to_i == selected_score %>
              <div class="list-group-item <%= 'list-group-item-success border-success' if is_selected %>
                                           <%= 'list-group-item-light' if !is_selected %>">
                <div class="d-flex w-100 justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <div class="me-3">
                      <% if is_selected %>
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 1.2rem;"></i>
                      <% else %>
                        <i class="bi bi-circle text-muted" style="font-size: 1.2rem;"></i>
                      <% end %>
                    </div>
                    <div>
                      <strong class="me-2"><%= score %></strong>
                      <%= text %>
                    </div>
                  </div>

                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<div class="mt-3">
  <%= link_to "Voltar ao Perfil", patients_dashboard_path, class: "btn btn-secondary" %>
</div>
