<h2><%= @scale_response.psychometric_scale.name %> — Resultado</h2>

<div class="mb-3">
  <strong>Paciente:</strong> <%= @scale_response.patient.full_name %><br/>
  <strong>Data:</strong> <%= l(@scale_response.completed_at, format: :short) %>
</div>

<div class="mb-3">
  <strong>Pontuação total:</strong> <%= @scale_response.total_score %><br/>
  <strong>Interpretação:</strong> <%= @scale_response.interpretation %>
</div>

<% if @scale_response.results.present? %>
  <% metrics = @scale_response.results["metrics"] || {} %>
  <% subscales = @scale_response.results["subscales"] || {} %>
  <% interp = @scale_response.results["interpretation"] || {} %>

  <% if metrics.present? %>
    <h3>Métricas</h3>
    <table class="table table-sm w-auto">
      <tbody>
      <% metrics.each do |key, value| %>
        <tr>
          <th class="text-nowrap"><%= key.humanize %></th>
          <td><%= value %></td>
        </tr>
      <% end %>
      </tbody>
    </table>
  <% end %>

  <% if subscales.present? %>
    <h3>Subescalas</h3>
    <table class="table table-sm w-auto">
      <tbody>
      <% subscales.each do |key, value| %>
        <tr>
          <th class="text-nowrap"><%= key.humanize %></th>
          <td><%= value %></td>
        </tr>
      <% end %>
      </tbody>
    </table>
  <% end %>

  <% if interp.present? && interp["rules"].present? %>
    <p class="text-muted">Regra: <%= interp["rules"] %></p>
  <% end %>
<% end %>

<h3>Respostas por item</h3>
<ol>
  <% @scale_response.psychometric_scale.scale_items.ordered.each do |item| %>
    <% key = "item_#{item.item_number}" %>
    <% score = @scale_response.answers[key].to_i %>
    <li class="mb-2">
      <div><strong><%= item.item_number %>. <%= item.question_text %></strong></div>
      <div>Resposta: <strong><%= score %></strong> — <%= item.options[score.to_s] %></div>
    </li>
  <% end %>
  </ol>

<div class="mt-3">
  <%= link_to "Voltar", :back, class: "btn btn-secondary" %>
</div>
