<% is_patient = current_user.account_type == "Patient" %>
<% is_professional_or_admin = current_user.email == "admin@admin.com" || current_user.account_type == "Professional" %>

<% if is_patient %>
  <h2><%= @scale_response.psychometric_scale.name %> — Respostas</h2>
<% else %>
  <h2><%= @scale_response.psychometric_scale.name %> — Resultado</h2>
<% end %>

<div class="row">
  <div class="col-9">
    <div class="mb-3">
      <strong>Paciente:</strong> <%= @scale_response.patient.full_name %><br/>
      <strong>Idade:</strong> <%= @scale_response.patient.age %> anos<br/>
      <strong>Solicitado em:</strong> <%= l(@scale_response.scale_request.requested_at, format: :short) %><br/>
      <strong>Preenchido em:</strong> <%= l(@scale_response.completed_at, format: :short) %><br/>
      <% if @scale_response.hetero_report? %>
        <strong>Relator:</strong> <%= @scale_response.relator_name %> (<%= @scale_response.relator_relationship %>)
      <% end %>
    </div>
  </div>
  
  <div class="col-3">
    <div class="row">
      <div class="col">
      <%= link_to "Voltar ao Perfil", patient_path(@scale_response.patient), class: "btn btn-secondary" %>
      
      </div>
      <div class="col">
        <% if policy(@scale_response).destroy? %>
          <%= button_to "Descartar Escala", scale_response_path(@scale_response), method: :delete, data: { turbo_confirm: "Tem certeza que deseja descartar esta escala? Esta ação cancelará a solicitação correspondente e não pode ser desfeita." }, class: "btn btn-danger" %>
        <% end %>
      </div>
    </div>  
  </div>

</div>

<% unless is_professional_or_admin %>
  <div class="mb-3">
    <h3>Aguardando análise profissional.</h3>
    <p>Mais informações sobre resultados, laudos e andamento de sua avaliação podem ser verificados em sua próxima consulta.</p>
  </div>
<% end %>

<% unless is_patient %>

  <!-- Renderizar partial específico para SRS-2 -->
  <%= render 'srs2/scale_responses/show', scale_response: @scale_response, is_professional_or_admin: is_professional_or_admin %>

  <!-- Seção de Respostas do Paciente -->
  <div class="mt-4">
    <div class="accordion" id="patientResponsesAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="patientResponsesHeader">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#patientResponsesCollapse" aria-expanded="false" aria-controls="patientResponsesCollapse">
            <i class="bi bi-list-ul me-2"></i>
            <h3>Respostas do Paciente</h3>
          </button>
        </h2>
        <div id="patientResponsesCollapse" class="accordion-collapse collapse" aria-labelledby="patientResponsesHeader" data-bs-parent="#patientResponsesAccordion">
          <div class="accordion-body">
            <% if @scale_response.answers.present? %>
              <div class="row">
                <% @scale_response.answered_items.each do |item| %>
                  <div class="col-12 mb-3">
                    <div class="border rounded p-3 bg-light">
                      <p class="mb-2"><strong><%= item[:item_number] %>. <%= item[:question_text] %></strong></p>
                      <div class="alert alert-success mb-0">
                        <strong> Resposta:</strong> <%= item[:answer_value] %> — <%= item[:answer_text] %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="alert alert-warning">
                <strong>Nenhuma resposta encontrada</strong> para esta escala.
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
