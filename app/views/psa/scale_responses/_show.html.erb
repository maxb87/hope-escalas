<% 
  # Mapeamento das categorias PSA
  psa_categories = {
    'A' => { name: 'Processamento Tátil/Olfativo', color: 'primary' },
    'B' => { name: 'Processamento Vestibular/Proprioceptivo', color: 'success' },
    'C' => { name: 'Processamento Visual', color: 'info' },
    'D' => { name: 'Processamento Tátil', color: 'warning' },
    'E' => { name: 'Nível de Atividade', color: 'danger' },
    'F' => { name: 'Processamento Auditivo', color: 'secondary' }
  }
%>

<div class="psa-results">
  <!-- Resumo Geral -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="card-title mb-0">
        <i class="bi bi-graph-up me-2"></i>
        Resumo Geral do PSA
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6>Pontuação Total</h6>
          <p class="h4 text-primary"><%= @scale_response.total_score %> pontos</p>
        </div>
        <div class="col-md-6">
          <h6>Nível Geral</h6>
          <% if @scale_response_adapter %>
            <span class="badge bg-<%= @scale_response_adapter.level_color(@scale_response_adapter.overall_level) %> fs-6">
              <%= @scale_response_adapter.level_description(@scale_response_adapter.overall_level) %>
            </span>
          <% else %>
            <span class="badge bg-secondary fs-6">Não disponível</span>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Análise por Categorias -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white">
      <h5 class="card-title mb-0">
        <i class="bi bi-bar-chart me-2"></i>
        Análise por Categorias Sensoriais
      </h5>
    </div>
    <div class="card-body">
      <% if @scale_response_adapter %>
        <div class="row">
          <% @scale_response_adapter.categories_with_levels.each do |category| %>
            <div class="col-md-6 col-lg-4 mb-3">
              <div class="card h-100">
                <div class="card-header bg-<%= psa_categories[category[:code]][:color] %> text-white">
                  <h6 class="card-title mb-0">
                    Categoria <%= category[:code] %>
                  </h6>
                </div>
                <div class="card-body">
                  <h6 class="card-title"><%= category[:title] %></h6>
                  <p class="card-text">
                    <strong>Pontuação:</strong> <%= category[:score] %>/<%= category[:max_possible_score] %>
                  </p>
                  <p class="card-text">
                    <strong>Nível:</strong> 
                    <span class="badge bg-<%= @scale_response_adapter.level_color(category[:level]) %>">
                      <%= @scale_response_adapter.level_description(category[:level]) %>
                    </span>
                  </p>
                  <p class="card-text small text-muted">
                    <%= category[:description] %>
                  </p>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-warning">
          <strong>Dados não disponíveis</strong> - Não foi possível carregar a análise das categorias.
        </div>
      <% end %>
    </div>
  </div>

  <!-- Interpretação -->
  <% if @interpretation %>
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">
          <i class="bi bi-lightbulb me-2"></i>
          Interpretação dos Resultados
        </h5>
      </div>
      <div class="card-body">
        <% if @interpretation[:introduction] %>
          <div class="mb-3">
            <h6>Introdução</h6>
            <p><%= @interpretation[:introduction].html_safe %></p>
          </div>
        <% end %>

        <% if @interpretation[:categories_analysis] %>
          <div class="mb-3">
            <h6>Análise das Categorias</h6>
            <p><%= @interpretation[:categories_analysis].html_safe %></p>
          </div>
        <% end %>

        <% if @interpretation[:overall_interpretation] %>
          <div class="mb-3">
            <h6>Interpretação Geral</h6>
            <p><%= @interpretation[:overall_interpretation].html_safe %></p>
          </div>
        <% end %>

        <% if @interpretation[:recommendations] %>
          <div class="mb-3">
            <h6>Recomendações</h6>
            <p><%= @interpretation[:recommendations].html_safe %></p>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Ações -->
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <%= link_to "Voltar para Escalas", scale_responses_path, class: "btn btn-outline-secondary" %>
    </div>
    <div>
      <% if is_professional_or_admin %>
        <%= link_to "Ver Interpretação", interpretation_psa_scale_response_path(@scale_response), 
            class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>
</div>
