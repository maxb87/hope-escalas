<% content_for :title, "PSA - Perfil Sensorial do Adulto/Adolescente" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h3 mb-1">PSA - Perfil Sensorial do Adulto/Adolescente</h1>
          <p class="text-muted mb-0">
            <strong>Paciente:</strong> <%= @scale_response.patient.full_name %>
          </p>
        </div>
      </div>

      <div class="alert alert-warning">
        <h3 class="alert-heading">
          <i class="bi bi-info-circle me-2"></i>
          Instruções
        </h3>
        <p class="mb-2">
          Este questionário avalia seu perfil sensorial em diferentes categorias. 
          Para cada afirmação, marque a opção que melhor descreve sua experiência.
        </p>
        <p>
          Responda todas as 60 questões em um único acesso. Selecione uma opção de 1 a 5 para cada pergunta.
        </p>
        <p>
          <strong>Escala:</strong> 
          <ul>
            <li>1 = Quase nunca</li>
            <li>2 = Raramente</li>
            <li>3 = Ocasionalmente</li>
            <li>4 = Frequentemente</li>
            <li>5 = Quase sempre</li>
          </ul>
        </p>
      </div>

      <% if current_user.email == "admin@admin.com" %>
        <div class="mb-3">
          <button type="button" class="btn btn-warning btn-sm" onclick="fillRandomAnswers()">
            <i class="bi bi-shuffle"></i> Preenchimento Aleatório (Teste)
          </button>
        </div>
      <% end %>

      <%= form_with model: [@scale_response], url: psa_scale_responses_path, method: :post, local: true, class: "psa-form" do |form| %>
        <%= hidden_field_tag :scale_request_id, @scale_request.id %>
        
        <!-- Renderizar partial específico para PSA -->
        <%= render 'psa/scale_responses/form', form: form, scale_response: @scale_response, scale_items: @scale_items %>

        <div class="d-flex justify-content-end mt-4">
          <div>
            <%= form.submit "Enviar Respostas", class: "btn btn-primary btn-lg", 
                data: { 
                  confirm: "Tem certeza que deseja finalizar o preenchimento do PSA? Você não poderá alterar as respostas após o envio.",
                  disable_with: "Finalizando..."
                } %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
function fillRandomAnswers() {
  // Preencher todas as respostas aleatoriamente
  const radioButtons = document.querySelectorAll("input[type='radio'][name*='scale_response[answers]']");
  
  // Agrupar por item
  const items = {};
  radioButtons.forEach(radio => {
    const name = radio.name;
    if (!items[name]) items[name] = [];
    items[name].push(radio);
  });
  
  // Selecionar uma opção aleatória para cada item
  Object.values(items).forEach(itemRadios => {
    const randomIndex = Math.floor(Math.random() * itemRadios.length);
    itemRadios[randomIndex].checked = true;
  });
  
  alert("Formulário PSA preenchido aleatoriamente!");
}
</script>

