<p style="color: green"><%= notice %></p>

<%= render @patient %>

<div>
  <%= link_to t('patients.show.edit_link'), edit_patient_path(@patient) %> |
  <%= link_to t('patients.show.back_link'), patients_path %>

  <%= button_to t('patients.show.destroy'), @patient, method: :delete, data: { confirm: t('patients.show.confirm_destroy') } %>
  <% if user_signed_in? && (current_user.email == "admin@admin.com" || current_user.account_type == "Professional") %>
    <div class="mt-3">
      <%= link_to t('patients.show.request_scale'), new_scale_request_path(patient_id: @patient.id), class: 'btn btn-primary' %>
    </div>
  <% end %>
</div>

<hr/>

<h2><%= t('patients.show.pending_requests') %></h2>
<% if @pending_requests.present? %>
  <table class="table table-striped">
    <thead>
      <tr>
        <th><%= t('dashboards.patients.scale_col') %></th>
        <th><%= t('dashboards.patients.requested_at_col') %></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% @pending_requests.each do |req| %>
        <tr>
          <td><%= req.psychometric_scale.name %></td>
          <td><%= l(req.requested_at, format: :short) %></td>
          <td>
            <%= link_to t('actions.show'), scale_request_path(req), class: 'btn btn-sm btn-outline-primary' %>
            <% if user_signed_in? && (current_user.email == "admin@admin.com" || current_user.account_type == "Professional") %>
              <%= link_to t('scale_requests.actions.cancel'), cancel_scale_request_path(req),
                  data: { turbo_method: :patch, turbo_confirm: t('scale_requests.actions.confirm_cancel') },
                  class: 'btn btn-sm btn-outline-danger ms-2' %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p><%= t('dashboards.patients.no_pending') %></p>
<% end %>

<h2 class="mt-4"><%= t('patients.show.completed_requests') %></h2>
<% if @completed_requests.present? %>
  <table class="table table-striped">
    <thead>
      <tr>
        <th><%= t('dashboards.patients.scale_col') %></th>
        <th><%= t('dashboards.patients.completed_at_col') %></th>
      </tr>
    </thead>
    <tbody>
      <% @completed_requests.each do |req| %>
        <% resp = req.scale_response %>
        <tr>
          <td><%= req.psychometric_scale.name %></td>
          <td><%= resp&.completed_at ? l(resp.completed_at, format: :short) : '-' %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p><%= t('dashboards.patients.no_completed') %></p>
<% end %>
